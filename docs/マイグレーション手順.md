# マイグレーション手順

マイグレーションで配下のパターンで手順が変わります。
1. 初期スキーマが存在する場合
  - [初期セットアップ](#初期セットアップ)から
2. 初期スキーマが存在しない場合
  - [以降のマイグレーション](#以降のマイグレーション)から

## 初期セットアップ

初期のデータベースに反映されているスキーマから Prisma でリバースエンジニアリングを行います。

### 手順

1. Prismaのリバースエンジニアリングを実行

```bash
# pnpm
pnpm dlx prisma db pull
```

## 以降のマイグレーション

初期セットアップ以降は、`prisma/schema.prisma` ファイルを編集してマイグレーションを行います。

### 手順

1. `prisma/schema.prisma` ファイルを編集

```**prisma**
model User {
id    Int     @id @default(autoincrement())
email String  @unique
name  String?
// 新しいフィールドを追加
createdAt DateTime @default(now())
}
```

2. マイグレーションファイルの作成と実行

```bash
# npm
npx prisma migrate dev --name add_created_at
# pnpm
pnpm dlx prisma migrate dev --name add_created_at
```

## 未適用のマイグレーション適用方法

```bash
# npm
npx prisma migrate dev
# pnpm
pnpm dlx prisma migrate dev
```

## スキーマ変更の手動適用

データベースが既に変更されている場合や、手動でスキーマを変更した場合は、以下の手順でマイグレーションファイルを作成し適用することができます。

### 手順

1. マイグレーションファイル用のディレクトリを作成

```bash
mkdir -p prisma/migrations/YYYYMMDDHHMMSS_pull_schema
```

2. 現在のスキーマと実際のデータベースの差分を取得

```bash
# pnpm
pnpm dlx prisma migrate diff \
  --from-schema-datamodel prisma/schema.prisma \
  --to-url="${DATABASE_URL}" \
  --script > prisma/migrations/YYYYMMDDHHMMSS_pull_schema/migration.sql
```

3. マイグレーションを適用済みとしてマークする

```bash
# pnpm
pnpm dlx prisma migrate resolve --applied YYYYMMDDHHMMSS_pull_schema
```

### 注意事項

- YYYYMMDDHHMMSSは実際の日時に置き換えてください
- この方法は、既存のデータベースの変更を追跡する必要がある場合にのみ使用してください
- 可能な限り、通常のPrismaマイグレーションワークフローを使用してください

## 注意事項

- 初期セットアップ後は、直接SQLでのスキーマ変更は避け、必ずPrismaを通じて行うこと
- マイグレーションファイル名は変更内容が分かるように具体的に記述すること
- マイグレーション実行前に、ローカル環境で十分なテストを行うこと
