# nextJSにおけるキャッシュとレンダリングについて
## 下記を参考に作成しました
[NextJSの考え方 第3部 キャッシュ](https://zenn.dev/akfm/books/nextjs-basic-principle/viewer/part_3)

## キャッシュについて
- Next.jsでは4種類のキャッシュがあります。

| キャッシュの種類 | 目的 | 保存対象 | 有効期間 | 保存場所 | 特徴 |
|-----------------|------|---------|---------|---------|------|
| **Request Memoization** | 同一リクエスト内での重複データフェッチを防止 | fetch()やReact.cacheで包まれた関数の結果 | 単一のレンダリングパス内のみ | サーバーメモリ（一時的） | • 同じリクエスト内で同じデータを複数回取得するのを防ぐ<br>• コンポーネントツリー内の重複フェッチを最適化 |
| **Data Cache** | データフェッチの結果を保存 | fetch()の結果 | 設定可能（デフォルトは無期限） | サーバー上のファイルシステム | • 複数のリクエスト間でデータを共有<br>• revalidateで更新間隔を制御可能<br>• cache: 'no-store'で無効化可能 |
| **Full Route Cache** | レンダリング済みルート全体を保存 | 静的にレンダリングされたページのHTML | 設定可能（デフォルトは無期限） | ビルド時に生成されるファイル | • SSG、ISRの基盤<br>• dynamic: 'force-dynamic'で無効化<br>• revalidateで更新間隔を制御可能 |
| **Router Cache** | クライアント側でのナビゲーション高速化 | ルートセグメントのペイロード | セッション中（設定可能） | ブラウザメモリ | • プリフェッチで先読み<br>• ページ遷移を高速化<br>• ユーザー操作に基づいて自動的に無効化 |

### 各キャッシュの関係

- **Request Memoization**：同じ重複データフェッチを勝手にまとめてくれる
- **Data Cache**：フェッチのレスポンスをキャッシュしてくれる
- **Full Route Cache**： CSR/SSR/SSG/ISRを実現してくれる
- **Router Cache**：[<Link>](https://nextjs.org/docs/pages/api-reference/components/link)で遷移する際に、遷移先のページをキャッシュしてくれる

## レンダリングについて
- NextJSではCSR、SSG、SSR、ISRの4種類のレンダリングがあります。

| レンダリングの種類 | `use～`などのHooksの利用 | レンダリング速度 | 特徴                                                                                   |
| ------------------ | ------------------------ | ---------------- | -------------------------------------------------------------------------------------- |
| **CSR**            | 〇                       | ☆               | ブラウザのJavaScriptでHTMLを生成                                                       |
| **SSG**            | ×                        | ☆☆             | ビルド時にHTMLを生成し、以降は静的ファイルを生成（fetchデータも事前にビルドされる）    |
| **SSR**            | ×                        | ☆☆☆☆         | サーバーで処理をして毎回HTMLを生成                                                     |
| **ISR**            | ×                        | ☆☆☆           | 静的ファイルを生成し、「検証」という操作、監視時間設定などをして条件が満たされると更新 |

## 覚えておくべきこと

### 優先度1 レンダリングの挙動の理解
- デフォルトではSSGが適用されます。
- ファイルの先頭に`useClient`と記載することでCSRになります。
  - 子コンポーネントもCSRでレンダリングされます。
  - `/src/app/dashboard/rendering/ClientDemo.tsx`を参照
- ファイルの先頭に`export const dynamic = 'force-dynamic'`と記載することでSSRになります。
  - 子コンポーネントもSSRでレンダリングされます。
  - `/src/app/dashboard/rendering/page.tsx`を参照
- `cookies()/headers()`などの[Dynamic APIs](https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-apis)と呼ばれるAPIを利用することでもSSRになります。
- ファイルの先頭に`export const revalidate = 10`と記載することでISRになります。
- fetchのオプションで`next: { revalidate: 10 }`と記載することでもISRになります。
- page.tsx + コンポーネントで一部でもCSRがある場合はCSR以外のコンポーネントはSSRになります。

### 優先度2 featchでのキャッシュ方法
- NextJSでは標準の`fetch`関数ではなく、`next/fetch`という通常の`fetch`関数をラップしたものを利用します。
- この`next/fetch`は`fetch`関数のキャッシュをサポートしています。

**デフォルト（キャッシュあり）**

```tsx
// (Next15以降)デフォルトでは結果がキャッシュされない
const data = await fetch('https://api.example.com/data')
```

**キャッシュを無効化**

```tsx
// キャッシュを無効化し、毎回新しいデータを取得(デフォルト)
const data = await fetch('https://api.example.com/data', { cache: 'no-store' })
```

**強制キャッシュ**

```tsx
// キャッシュを強制的に有効化
const data = await fetch('https://api.example.com/data', { cache: 'force-cache' })
```


**再検証期間の設定**

```tsx
// 10秒ごとにデータを再検証
const data = await fetch('https://api.example.com/data', { next: { revalidate: 10 } })
```
